name: Build and Push Docker Images

on:
  push:
    branches:
      - main
    paths:
      - 'docker-bake.hcl'
  workflow_dispatch:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      release: ${{ steps.extract.outputs.release }}
      registry_user: ${{ steps.extract.outputs.registry_user }}
      should_build: ${{ steps.check.outputs.should_build }}
      targets: ${{ steps.targets.outputs.targets }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Extract variables from docker-bake.hcl
        id: extract
        run: |
          RELEASE=$(grep 'variable "RELEASE"' -A 2 docker-bake.hcl | grep 'default' | sed 's/.*"\(.*\)"/\1/')
          REGISTRY_USER=$(grep 'variable "REGISTRY_USER"' -A 2 docker-bake.hcl | grep 'default' | sed 's/.*"\(.*\)"/\1/')

          echo "release=${RELEASE}" >> $GITHUB_OUTPUT
          echo "registry_user=${REGISTRY_USER}" >> $GITHUB_OUTPUT

          echo "Current RELEASE: ${RELEASE}"
          echo "Current REGISTRY_USER: ${REGISTRY_USER}"

      - name: Check if RELEASE changed
        id: check
        run: |
          # For manual triggers, always build
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "Manual trigger - will build"
            exit 0
          fi

          # Check if docker-bake.hcl was modified
          if ! git diff HEAD^ HEAD --name-only | grep -q "docker-bake.hcl"; then
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "docker-bake.hcl not modified - skipping build"
            exit 0
          fi

          # Get RELEASE value from current commit
          CURRENT_RELEASE=$(grep 'variable "RELEASE"' -A 2 docker-bake.hcl | grep 'default' | sed 's/.*"\(.*\)"/\1/')

          # Get RELEASE value from previous commit
          git show HEAD^:docker-bake.hcl > /tmp/docker-bake-prev.hcl
          PREV_RELEASE=$(grep 'variable "RELEASE"' -A 2 /tmp/docker-bake-prev.hcl | grep 'default' | sed 's/.*"\(.*\)"/\1/')

          echo "Previous RELEASE: ${PREV_RELEASE}"
          echo "Current RELEASE: ${CURRENT_RELEASE}"

          # Compare RELEASE values
          if [ "${PREV_RELEASE}" != "${CURRENT_RELEASE}" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "RELEASE changed from '${PREV_RELEASE}' to '${CURRENT_RELEASE}' - will build"
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "RELEASE unchanged - skipping build"
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract build targets
        id: targets
        run: |
          TARGETS=$(docker buildx bake -f docker-bake.hcl all --print 2>/dev/null | jq -c '[.target | keys[]]')
          echo "targets=${TARGETS}" >> $GITHUB_OUTPUT
          echo "Targets: ${TARGETS}"

  build-and-push:
    needs: detect-changes
    if: needs.detect-changes.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJson(needs.detect-changes.outputs.targets) }}

    steps:
      - name: Free up disk space
        run: |
          echo "=== Before cleanup ==="
          df -h /

          # Remove swap
          sudo swapoff -a
          sudo rm -f /swapfile

          # Remove large pre-installed tools and frameworks
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc \
            /usr/local/share/boost /opt/hostedtoolcache /usr/share/swift \
            /usr/local/.ghcup /usr/local/graalvm /usr/local/share/powershell \
            /usr/local/share/chromium /usr/local/lib/node_modules

          # Remove pre-installed apt packages we don't need
          sudo apt-get purge -y \
            dotnet-* aspnetcore-* azure-cli google-cloud-cli \
            firefox mysql-* postgresql-* mongodb-* moby-* \
            powershell php* snapd google-chrome-stable microsoft-edge-stable \
            2>/dev/null || true
          sudo apt-get autoremove -y
          sudo apt-get clean

          # Remove pre-cached docker images
          docker image prune -af

          echo "=== After cleanup ==="
          df -h /

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push ${{ matrix.target }}
        uses: docker/bake-action@v6
        with:
          files: docker-bake.hcl
          targets: ${{ matrix.target }}
          push: true
